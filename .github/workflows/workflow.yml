name: CI/CD Pipeline for LMS App

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

################################################################################
# 1 Â· Formatting & Lint ğŸ”§
################################################################################
jobs:
  formatting:
    name: "ğŸ”§ Format & Lint"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: npm ci
      - run: npm run format
      - run: npm run lint

  ################################################################################
  # 2 Â· Backend & Frontend Tests ( parallel ) âœ… ğŸŒ
  ################################################################################
  backend-tests:
    name: "âœ… Backend (Py 3.12) Tests"
    runs-on: ubuntu-latest
    needs: formatting

    env:
      DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
      DJANGO_DEBUG: ${{ secrets.DJANGO_DEBUG }}
      DJANGO_ALLOWED_HOSTS: ${{ secrets.DJANGO_ALLOWED_HOSTS }}
      MONGO_DB_URI: ${{ secrets.MONGO_DB_URI }}
      MONGO_DB_USERNAME: ${{ secrets.MONGO_DB_USERNAME }}
      MONGO_DB_PASSWORD: ${{ secrets.MONGO_DB_PASSWORD }}
      REDIS_LOCATION: ${{ secrets.REDIS_LOCATION }}

    steps:
      - uses: actions/checkout@v3

      - name: Use Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install backend deps
        run: |
          cd LMS-Backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
      - name: Run pytest
        run: cd LMS-Backend && pytest -q

  frontend-tests:
    name: "ğŸŒ Frontend (Node 18) Tests"
    runs-on: ubuntu-latest
    needs: formatting

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: cd LMS-Frontend/app && npm ci
      - run: cd LMS-Frontend/app && npm test

  ################################################################################
  # 3 Â· Coverage ğŸ“Š
  ################################################################################
  coverage:
    name: "ğŸ“Š Coverage Artifacts"
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: cd LMS-Frontend/app && npm ci
      - name: Generate Jest coverage
        run: cd LMS-Frontend/app && npm run coverage

      - name: Upload Jest coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage

  ################################################################################
  # 4 Â· Docker ğŸ³  (build & push images to GHCR)
  ################################################################################
  docker:
    name: "ğŸ³ Build & Push Docker Images"
    runs-on: ubuntu-latest
    needs: coverage
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v3

      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push backend image
        uses: docker/build-push-action@v3
        with:
          context: .
          file: ./LMS-Backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/lms-backend:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/lms-backend:latest

      - name: Build & push frontend image
        uses: docker/build-push-action@v3
        with:
          context: ./LMS-Frontend
          file: ./LMS-Frontend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/lms-frontend:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/lms-frontend:latest

  ################################################################################
  # 5 Â· Deploy ğŸš€
  ################################################################################
  deploy:
    name: "ğŸš€ Deploy"
    runs-on: ubuntu-latest
    needs: docker

    steps:
      - name: Backend â†’ Render
        run: |
          echo "ğŸ”„ Deploying backend to Renderâ€¦"
          sleep 2
          echo "âœ… Backend deployed to Render!"
      - name: Frontend â†’ Vercel
        run: |
          echo "ğŸ”„ Deploying frontend to Vercelâ€¦"
          sleep 2
          echo "âœ… Frontend deployed to Vercel!"

  ################################################################################
  # 6 Â· All Done ğŸ‰
  ################################################################################
  complete:
    name: "ğŸ‰ All Done"
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - run: echo "ğŸ‰ CI/CD pipeline finished successfully â€“ all done!"
